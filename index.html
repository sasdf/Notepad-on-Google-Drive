<!doctype html>
<html>
  <head>
    <title>Notepad</title>
    <script>
      var AppUrl = 'https://script.google.com/macros/s/AKfycbzusPtaiE-aQigLHVhqkCWV82VqPnUZPJ0-SxnmLZ_7c1XPpr4/exec'
      function uid(n){
        return Array(n).fill(0).map(function(){
          return "abcdefghijklmnopqrstuvwxyz0123456789"[Math.floor(Math.random() * 36)]
        }).join('')
      }
      if(window.location.hash === ""){
        window.location.replace('#'+uid(8))
      }
    </script>
    <style>
      html{
        height: 100%;
      }
      body{
        background-color: #eee;
        text-align: center;
        height: 100%;
        overflow: hidden;
        padding: 5% 10%;
        box-sizing: border-box;
        margin: 0px;
      }
      #text{
        border: none;
        resize: none;
        height: 100%;
        width: 100%;
        padding: .5rem;
        box-sizing: border-box;
        outline: none;
      }
      #textContainer{
        border-radius: .5rem;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        padding: 1rem;
        border: 1px solid #AAA;
        overflow: hidden;
        background: #fff;
        transition: box-shadow .5s;
      }
      .normal { box-shadow: 0px .3rem .8rem 0px   rgba(0  ,0  ,0  ,0.5); }
      .loading{ box-shadow: 0px .3rem 1rem  .1rem rgba(230,230,80 ,0.8); }
      .error  { box-shadow: 0px .3rem .8rem 0px   rgba(255,0  ,0  ,0.6); }
      .success{ box-shadow: 0px .3rem 1rem  .1rem rgba(80 ,180,80 ,1  ); }
      .saving { box-shadow: 0px .3rem 1rem  0px   rgba(0  ,200,200,0.6); }
    </style>
  </head>
  <body>
    <div id="textContainer" class="loading">
      <textarea id="text"></textarea>
    </div>
    <script>
      var cssTimer, subTimer
      var textCon = document.getElementById('textContainer')
      var text = document.getElementById('text')
      var lastText, waitText
      
      function cssClear(){
        if(cssTimer) clearTimeout(cssTimer)
        cssTimer = false
      }
      function cssBack(){
        cssClear()
        cssTimer = setTimeout(function(){
          textCon.className = 'normal'
          textCon.csstimer = undefined
        }, 2000)
      }
      
      lastText = text.value
      waitText = text.value
      window.onload = loadData
      window.onhashchange = loadData
      text.onblur = startsub
      text.onkeyup = startsub
      setInterval(sub, 10000)
      function loadData(){
        cssClear()
        if(subTimer) clearTimeout(subTimer)
        subTimer = false
        textCon.className = 'loading'
        var req = new XMLHttpRequest()
        req.open('GET', AppUrl + '?file=' + encodeURIComponent(window.location.hash))
        req.onload = function(){
          text.value = req.responseText
          lastText = text.value
          waitText = text.value
          cssBack()
          textCon.className = 'success'
        }
        req.send()
      }
      function startsub(){
        if(subTimer && waitText === text.value) return
        waitText = text.value
        if(subTimer) clearTimeout(subTimer)
        subTimer = setTimeout(sub, 1000)
      }
      function sub(){
        if(subTimer) clearTimeout(subTimer)
        subTimer = false
        if(lastText === text.value) return
        var tmp = lastText
        cssClear()
        lastText = text.value
        textCon.className = 'saving'
        var formData = new FormData();
        formData.append('file', window.location.hash);
        formData.append('value', text.value)
        var req = new XMLHttpRequest()
        req.open('POST', AppUrl)
        req.onload = function(){
          cssBack()
          if(req.responseText === "true"){
            textCon.className = 'success'
          }else{
            lastText = tmp
            textCon.className = 'error'
          }
        }
        req.send(formData)
      }
    </script>
  </body>
</html>
